name: Test cargo-set-dependency

on:
  pull_request:
    paths-ignore:
      - "**.md"

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  cargo-set-dependency:
    name: "Set version"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        dependency:
          - version: |
              {
                "git": "https://github.com/fluencelabs/marine",
                "branch": "master",
                "features": ["raw-module-api"]
              }
          - version: |
              {
                "version": "=0.22.1",
                "features": ["raw-module-api"]
              }

    steps:
      - uses: actions/checkout@v3

      - name: Setup rust toolchain
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Prepare Cargo.toml
        run: |
          cat <<-CARGO > Cargo.toml
          [package]
          name = "test"
          version = "0.1.0"
          edition = "2018"

          [dependencies]
          fluence-app-service = "0.20.0"
          CARGO

      - name: Prepare cargo source
        run: |
          mkdir src
          cat <<-SRC > src/main.rs
          fn main() {
              println!("Hello, world!");
          }
          SRC

      - name: Prepare cargo config
        run: |
          mkdir .cargo
          cat <<-SETTINGS > .cargo/config.toml
          [registries]
          fluence = { index = "git://crates.fluence.dev/index" }
          SETTINGS

      - name: Set cargo version
        uses: ./cargo-set-dependency
        with:
          package: "fluence-app-service"
          version: ${{ matrix.dependency.version }}
